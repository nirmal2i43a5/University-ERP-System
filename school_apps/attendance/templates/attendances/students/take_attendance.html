{% extends 'admin_templates/base_admin.html' %} {% block title %}Take Student
Attendance {% endblock %} {% load crispy_forms_tags %} {% load static %} {% block main_content %}

<!-- Main content -->

<section class="content">
  <div class="container-fluid">
    <!-- /.card-header -->

    <div class="d-flex bd-highlight">
      <div class="flex-grow-1 bd-highlight">
        <div class="card pt-3 pl-2">
          <div
            class="card-header mb-2 mr-1"
            style="background:-webkit-linear-gradient(left, #1f12d3, #6b75e0); color: white"
          >
            <strong> Student Attendance</strong>
            <a
            href=""
            class="btn btn-sm btn-info"
            style="background-color: #743db8;float:right;"
            ><i class="fas fa-sync"></i
          ></a>
          </div>

          <!-- -------------------------Subject filter form ------------------------------------------------ -->
          <form method="POST">
            <div class="input-group">
              {% csrf_token %} {{ form|crispy }}
              <div class="input-group-btn ml-1 mt-1 mb-1">
                <button
                  type="submit"
                  class="btn btn-sm"
                  id="take_attendance"
                  style="background:-webkit-linear-gradient(left, #1f12d3, #6b75e0); color: white"
                >
                  <strong>Take Student Attendance</strong>
                </button>
               
              </div>
            </div>
          </form>
          <!-- -------------------------Subject filter form end------------------------------------------------ -->
        </div>
      </div>

    
    </div>

    <!-- -------------------------attendace save form ------------------------------------------------ -->
    <div class="row">
      <div class="col-sm-12 col-lg-12">
            {% comment %} <h5 class="card-title">Card title</h5> {% endcomment %}
              {% if course_category %}
        <div class="d-flex flex-column bd-highlight" style="margin-right: 10%">
          <div class="card px-4 py-3 ml-4 mt-0">
            <div class="p-1 bd-highlight">
              <strong>Course Category :</strong>:
              <span class="badge badge-info">{{course_category}}</span>
            </div>
            <div class="p-1 bd-highlight">
              <strong>Course :</strong>:
              <span class="badge badge-info">{{course}}</span>
            </div>
            <div class="p-1 bd-highlight">
              <strong>Semester</strong>: {{ semester.name }}
            </div>
            <div class="p-1 bd-highlight">
              <strong>Section</strong>: {{ section.section_name }}
            </div>
            <div class="p-1 bd-highlight">
              <strong>Subject</strong>: {{ subject }}
          </div>
        </div>
      </div>

      {% endif %}
      </div>
    </div>
    {% comment %} <div class="container"> {% endcomment %}
    
    <form action="{% url 'attendance_app:save_student_attendance' %}" method="POST">
    
      <!-- <input type="hidden" name = "semester_id" value = "{{ semester.id }}">
        <input type="hidden" name = "section_id" value = "{{ section.id }}"> -->

      {% csrf_token %}

      <div class="card">
        <!-- /.card-header -->
        <div class="card-body">
          
          {% if students %}

          <div class="d-flex bd-highlight">
            <div class="p-2 flex-fill bd-highlight">
              <label
                class="mt-1"
                style="
                  text-align: right;
                  clear: both;
                  float: left;
                  margin-right: 10px;
                "
                for=""
              >
                Attendance Date:</label
              >
              <input
                type="date"
                id="attendance_date"
                name="attendance_date"
                class="form-control col-md-6"
                required
              />
            </div>
          </div>

          <hr />

          <div class="container-fluid">
            <div class="row">
              {% for student in students %}
              <div class="col-lg-4 col-md-6 col-sm-12 mb-4">
                <div class="row align-items-center">
                  <strong> {{forloop.counter}}</strong> .

                  <div class="col-2">
                    {% if student.image %}
          
                    <a href="{{ student.image.url }}">   <img src="{{ student.image.url }}" alt="" style="width:35px;height:35px;" class="img-circle" /></a>
          
                      {% else %}
                      <img src="{% static 'image/default_profile.png' %}" alt="" style="width:35px;height:35px;" class="img-circle" />
                      {% endif %}
                  </div>
                  <div class="col-4">
                    <a href="{% url 'admin_app:view_student' student.id %}">
                      {{ student.student_user.full_name }}
                      {% comment %} <strong
                        >( {{ student.student_user.username }})</strong
                      > {% endcomment %}
                    </a>
                  </div>
                  <div class="col-5">
                   
                    <select class="status" name="{{ student.student_user.id }}">
          
                      <option value="Present" selected>Present</option>
                  
                          <option value="Absent(Informed)">Absent(Informed)</option>
                  
                          <option value="Absent(Not Informed)">
                            Absent(Not Informed)
                          </option>
                  
                          <option value="Late">Late</option>
                  
                          <option value="Excused">Excused</option>
                    </select>
                  </div>
                </div>
              </div>
              {% endfor %}
            
             
            </div>
          </div>
        </div>

      </div>
     
        <!-- /.card-body -->
      
      <!-- /.card -->
      <a
        href="{% url 'attendance_app:manage_student_attendance' %}"
        id="save_attendance"
        class="btn btn-sm btn-info btn-danger mb-3"
        ><strong>Back</strong></a
      >
      <button
        type="button"
        id="save_attendance"
        class="btn btn-sm btn-success mb-3"
      >
        <strong>Save Attendance</strong>
      </button>
      {% endif %}
    </form>

    <!-- {% if not students %}
    <div class="alert alert-default-danger">No Student Found. Please, Add Student To Particular Class.
    </div>

    {% else %}



    {% endif %} -->
    <div class="alert alert-default-warning">
      Please, Search Appropriate Class, Section, and Subject For Taking
      Attendance.
    </div>
  </div>
</section>
<!-- /.content -->

{% endblock main_content %} {% block custom_js %}

<script>
  $(document).ready(function () {
    $(document).on("click", "#save_attendance", function () {
      var student_data = $("select[class='status']")
        .map(function () {
          //  alert($(this).attr('name'))
          status = $(this).children("option:selected").val();
          student_id = $(this).attr("name");
          // remark = $('#id_remark').val()

          if ($(this).find("option:selected")) {
            console.log($(this).attr("name"));
            console.log($(this).attr("name"));
            // console.log({ "id": $(this).attr('name') , "status": text,'remark':remark })

            return { id: student_id, status: status };
          }
        })
        .get();
      var course_category_id = $("#id_course_category").val();
      var course_id = $("#id_filter_course").val();
      var attendance_date = $("#attendance_date").val();
      var semester_id = $("#id_filter_semester").val();
      //   var faculty_id = $("#id_group").val();
      var subject_id = $("#id_subject").val();
      var section_id = $("#id_section").val();
      student_data = JSON.stringify(student_data);

      $.ajax({
        url: "{% url 'attendance_app:save_student_attendance' %}",
        type: "POST",
        data: {
          course_category_id: course_category_id,
          course_id: course_id,
          student_ids: student_data,
          attendance_date: attendance_date,
          subject_id: subject_id,
          semester_id: semester_id,
          section_id: section_id,
        },
        error: function (e) {
          alert("Failed To Add Attendance !");
        },
        success: function (response) {
          if (response.status == "Save Success") {
            alert(response.message);
            window.location.href = "/student_attendance_report/";
          }
          if (response.status == "False Date Select") {
            alert(response.message);
            window.location.href = "/student_attendance_report/";
          }
          if ((response.status = "Attendance Already Exists")) {
            alert(response.message);
            location.reload();
          }
        },
      });
    });




    //Default date picker 

    var now = new Date();
    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);
    var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
   $('#attendance_date').val(today);


    //Date picker end
    
     $("#id_course_category").change(function(){
          var course_category_id = $(this).val();
          
          $.ajax({
              url:" {% url 'attendance_app:fill_semester_select' %}",
              data:{'course_category':course_category_id},
              success:function(data){
                  $("#id_semester").html(data);
              }
          })
      })
      
      
      $("#id_filter_semester").change(function(){
        var semester_id = $(this).val();
        
        
        $.ajax({
            url:" {% url 'attendance_app:fill_section_select' %}",
            data:{'semester':semester_id},
            success:function(data){
                $("#id_section").html(data);
            }
        })
      })
      
$("#id_course_category").change(function(){
  var course_category_id = $(this).val();
  
  $.ajax({
      url:" {% url 'attendance_app:fill_course_select' %}",
      data:{'course_category':course_category_id},
      success:function(data){
          $("#id_filter_course").html(data);
      }
  })
})

      
      $("#id_filter_semester").change(function(){
        var semester_id = $(this).val();
        var course_category_id = $('#id_course_category').val();
        
        
        $.ajax({
            url:" {% url 'attendance_app:fill_subject_select' %}",
            data:{'semester':semester_id,'course_category':course_category_id},
            success:function(data){
                $("#id_subject").html(data);
            }
        })
      })
  
    
  });

  /*
$("#id_section").change(function(){
  var section_id = $(this).val();
  
  $.ajax({
      url:" ",
      data:{'section':section_id},
      success:function(data){
          $("#id_subject").html(data);
      }
  })
})*/




</script>


{% endblock custom_js %}

<div class="container-fluid">
  <div class="row">
    {% for student in students %}

    <div class="col-12 col-sm-6 col-md-4 mb-3">
      <div class="row align-items-center">

        <div class="col-2 col-sm-2">
          <strong> {{forloop.counter}}</strong> .
  
          {% if student.image %}

          <a href="{{ student.image.url }}">   <img src="{{ student.image.url }}" alt="" style="width:35px;height:35px;" class="img-circle" /></a>

            {% else %}
            <img src="{% static 'image/default_profile.png' %}" alt="" style="width:35px;height:35px;" class="img-circle" />
            {% endif %}
        </div>
        <div class="col-4 col-sm-4">
          <a href="{% url 'admin_app:view_student' student.id %}">
            {{ student.student_user.full_name }}
            {% comment %} <strong
              >( {{ student.student_user.username }})</strong
            > {% endcomment %}
          </a>
        </div>
        <div class="col-6 col-sm-6">
          <select class="status" name="{{ student.student_user.id }}">

            <option value="Present" selected>Present</option>
            <option value="Absent(Informed)">Absent(Informed)</option>
            <option value="Absent(Not Informed)">Absent(Not Informed)</option>
            <option value="Late">Late</option>
            <option value="Excused">Excused</option>
          </select>
        </div>
      </div>
    </div>
    {% endfor %}
    
  
    
 
    
  </div>
</div>